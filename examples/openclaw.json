{
  // ============================================================
  // OpenClaw Configuration — Recommended Multi-Agent Setup
  // ============================================================
  // NOTE: This file uses JSON5 comments (//) for documentation.
  // OpenClaw supports JSON5 natively — no need to strip comments.
  //
  // Three-agent architecture:
  //   Main agent     — channel-facing, sandboxed (Docker network:none),
  //                    no exec/web/browser. Delegates all work via sessions_send.
  //   Computer agent — full exec + browser, sandboxed on egress-allowlisted
  //                    Docker network. Only pre-approved hosts reachable.
  //   Search agent   — web_search/web_fetch only, no filesystem, no exec.
  //
  // Optional: Dedicated channel agents (defense-in-depth) — commented out below.
  //   Uncomment to route channels to restricted agents instead of main.
  //
  // Prerequisites:
  //   1. Docker network "openclaw-egress" created (scripts/network-egress/setup-network.sh)
  //   2. Firewall rules applied (scripts/network-egress/apply-rules.sh)
  //   3. Egress allowlist configured (scripts/network-egress/allowlist.conf)
  //   4. Guard plugins installed (channel-guard, web-guard, agent-guard)
  //   5. Docker or OrbStack running
  //   Simpler alternative: Set computer's network to "none" — skip egress setup,
  //   but computer can't npm install, git push, or browse. See comment in agent config.
  //
  // See content/docs/hardened-multi-agent.md for the full egress allowlisting walkthrough.
  //
  // DEPLOYMENT OPTIONS:
  //   Docker isolation — Dedicated OS user + Docker/OrbStack (this config): stronger
  //                      internal agent isolation via Docker sandboxing.
  //                      Egress allowlisting requires Docker bridge + host firewall.
  //   VM: macOS VMs — Lume / Parallels: stronger host isolation, no Docker inside VM.
  //                   Remove all "sandbox" blocks; tool policy provides internal isolation.
  //                   Egress allowlisting not available (no Docker bridge).
  //   VM: Linux VMs — Multipass / KVM: strongest combined posture (VM boundary + Docker).
  //                   Keep "sandbox" blocks — Docker works inside Linux VMs.
  //   See Phase 3 — Security for the full trade-off analysis.
  //
  // Replace placeholder values:
  //   +46XXXXXXXXX  → your phone number
  //   user@yourdomain.com → your Google Chat email
  //   <node-name>.<tailnet> → your Tailscale node
  //
  // Environment variables (set in LaunchDaemon/LaunchAgent plist or systemd EnvironmentFile):
  //   OPENCLAW_GATEWAY_TOKEN
  //   ANTHROPIC_API_KEY
  //   BRAVE_API_KEY (or OPENROUTER_API_KEY for Perplexity)
  //   OPENROUTER_API_KEY (required for image-gen plugin; also used by Perplexity)
  //   GITHUB_TOKEN
  //   GOOGLE_CHAT_SERVICE_ACCOUNT_FILE (path to service account JSON key)
  // See Phase 6 — Deployment > Secrets Management for details.
  // ============================================================

  // --- Chat Commands ---
  // Disable dangerous chat commands. These allow users to
  // run shell commands, edit config, or restart the gateway
  // from within a chat message.
  "commands": {
    "native": "auto",
    "nativeSkills": "auto",
    "bash": false,       // Blocks !command shell access
    "config": false,     // Blocks /config writes
    "debug": false,      // Blocks /debug runtime overrides
    "restart": false     // Blocks /restart
  },

  // --- Global Tool Restrictions ---
  "tools": {
    // Only deny tools globally that NO agent should ever have.
    // Per-agent tools (exec, browser, web_search, etc.) are controlled in each
    // agent's allow/deny — global deny overrides agent-level allow.
    "deny": ["canvas", "gateway", "nodes"],

    // Disable elevated mode globally — prevents sandbox escape
    "elevated": { "enabled": false },

    // Web search provider config (accessible only to agents that allow web_search)
    "web": {
      "search": {
        "enabled": true,
        "provider": "brave",
        "apiKey": "${BRAVE_API_KEY}"

        // Alternative: Perplexity via OpenRouter
        // "provider": "perplexity",
        // "perplexity": {
        //   "apiKey": "${OPENROUTER_API_KEY}",
        //   "baseUrl": "https://openrouter.ai/api/v1",
        //   "model": "perplexity/sonar-pro"
        // }
      }
    }
  },

  // --- Skills ---
  // Only allow known-good bundled skills. No skill installer configured
  // means no new skills can be added from ClawHub.
  "skills": {
    "allowBundled": ["coding-agent", "github", "healthcheck", "weather", "video-frames"]
  },

  // --- Session Isolation ---
  "session": {
    // Each sender on each channel gets their own isolated session
    "dmScope": "per-channel-peer",

    // Inter-agent communication settings
    "agentToAgent": {
      "maxPingPongTurns": 5
    }
  },

  // --- Agents ---
  "agents": {
    "defaults": {
      // Pre-compaction memory flush — saves important context to memory before compacting.
      // Without this, the agent forgets everything from the compacted conversation portion.
      "compaction": {
        "mode": "safeguard",
        "reserveTokensFloor": 20000,
        "memoryFlush": {
          "enabled": true,
          "softThresholdTokens": 4000,
          "systemPrompt": "Session nearing compaction. Store durable memories now.",
          "prompt": "Write any lasting notes to memory/YYYY-MM-DD.md; reply with NO_REPLY if nothing to store."
        }
      },

      // Memory search — semantic + keyword hybrid search across memory files.
      // Local provider: no API key, ~500MB disk, full privacy.
      "memorySearch": {
        "enabled": true,
        "provider": "local",
        "query": {
          "hybrid": {
            "enabled": true,
            "vectorWeight": 0.7,
            "textWeight": 0.3
          }
        },
        "cache": {
          "enabled": true,
          "maxEntries": 50000
        }
      },
      "maxConcurrent": 4,
      "subagents": {
        "maxConcurrent": 8,
        "model": "anthropic/claude-sonnet-4-5",
        "thinking": "low"
      }
      // NOTE: No default sandbox block — each agent defines its own sandbox explicitly.
      // All three core agents use mode:"all" with different network settings,
      // so a shared default would be misleading.
    },
    "list": [
      {
        // MAIN AGENT — receives all channel input, delegates everything
        // Sandboxed with network:none — even if fully compromised, zero exfiltration path.
        // Uses tools.allow (exclusive list) for strictest enforcement.
        // Delegates coding/exec to computer, web search to search via sessions_send.
        "id": "main",
        "default": true,
        "workspace": "/Users/openclaw/.openclaw/workspaces/main",
        "agentDir": "/Users/openclaw/.openclaw/agents/main/agent",
        "tools": {
          "allow": ["group:fs", "group:sessions", "group:memory", "message"],
          "deny": ["group:runtime", "group:web", "browser", "group:ui", "group:automation"],
          "elevated": { "enabled": false }
        },
        "subagents": { "allowAgents": ["computer", "search"] },
        // Signal has no native @mention — regex patterns for group mention gating.
        // Placed on main because all channels (including Signal) route here via bindings.
        "groupChat": {
          "mentionPatterns": ["@openclaw", "hey openclaw"]
        },
        "sandbox": {
          "mode": "all",
          "scope": "agent",
          "workspaceAccess": "rw",
          "docker": { "network": "none" }
        }
      },
      {
        // COMPUTER AGENT — full exec + browser, egress-allowlisted network
        // Does the actual work: coding, file ops, git, builds, browser automation.
        // Browser consolidated here (not a separate agent) — more secure than Phase 5
        // pattern because browsing happens on egress-allowlisted network instead of
        // network:host. Computer already has exec, could install Playwright anyway.
        // Denies web_search (delegates to search agent) and message (can't send to channels).
        "id": "computer",
        "workspace": "/Users/openclaw/.openclaw/workspaces/computer",
        "agentDir": "/Users/openclaw/.openclaw/agents/computer/agent",
        "tools": {
          "allow": ["group:runtime", "group:fs", "group:memory", "group:sessions", "browser", "web_fetch"],
          "deny": ["web_search", "group:ui", "message"],
          "elevated": { "enabled": false }
        },
        "subagents": { "allowAgents": ["search"] },
        "sandbox": {
          "mode": "all",
          "scope": "agent",
          "workspaceAccess": "rw",
          // Custom Docker network with host-level firewall rules restricting
          // outbound traffic to allowlisted hosts only (npm, git, Playwright CDN, etc.)
          // See hardened-multi-agent.md for egress setup walkthrough.
          "docker": { "network": "openclaw-egress" }
          // Simpler alternative (no egress setup needed):
          // "docker": { "network": "none" }
          // Trade-off: computer can't npm install, git push, or browse.
        }
      },
      {
        // SEARCH AGENT — isolated web search + content processing
        // Only reachable via sessions_send from main or computer.
        // No channel binding = can't be messaged directly.
        // No filesystem tools — nothing to read or exfiltrate.
        // Cheaper model — search queries don't need Opus.
        "id": "search",
        "workspace": "/Users/openclaw/.openclaw/workspaces/search",
        "agentDir": "/Users/openclaw/.openclaw/agents/search/agent",
        "model": "anthropic/claude-sonnet-4-5",
        "tools": {
          "allow": ["web_search", "web_fetch", "sessions_send", "session_status"],
          "deny": ["exec", "read", "write", "edit", "apply_patch", "process", "browser", "gateway", "cron"]
        },
        "subagents": { "allowAgents": [] },
        "sandbox": {
          "mode": "all",
          "scope": "agent",
          "workspaceAccess": "none"
        }
      }

      // --- OPTIONAL: Dedicated channel agents (defense-in-depth) ---
      // Uncomment to route channels to restricted agents instead of main.
      // Each channel agent has no exec/process — delegates to main/computer/search.
      // Also uncomment the corresponding bindings in the bindings section below.
      // TODO: remove after openclaw#15176 merges
      // NOTE: Requires OpenClaw > 2026.2.12 — channel bindings to non-default
      // agents are broken in 2026.2.12 (session path regression).
      //
      // ,{
      //   "id": "whatsapp",
      //   "workspace": "/Users/openclaw/.openclaw/workspaces/whatsapp",
      //   "agentDir": "/Users/openclaw/.openclaw/agents/whatsapp/agent",
      //   "tools": {
      //     "deny": ["web_search", "web_fetch", "browser", "exec", "process"],
      //     "elevated": { "enabled": false }
      //   },
      //   "subagents": { "allowAgents": ["main", "computer", "search"] }
      // },
      // {
      //   "id": "signal",
      //   "workspace": "/Users/openclaw/.openclaw/workspaces/signal",
      //   "agentDir": "/Users/openclaw/.openclaw/agents/signal/agent",
      //   "tools": {
      //     "deny": ["web_search", "web_fetch", "browser", "exec", "process"],
      //     "elevated": { "enabled": false }
      //   },
      //   "subagents": { "allowAgents": ["main", "computer", "search"] }
      // },
      // {
      //   "id": "googlechat",
      //   "workspace": "/Users/openclaw/.openclaw/workspaces/googlechat",
      //   "agentDir": "/Users/openclaw/.openclaw/agents/googlechat/agent",
      //   "tools": {
      //     "deny": ["web_search", "web_fetch", "browser", "exec", "process"],
      //     "elevated": { "enabled": false }
      //   },
      //   "subagents": { "allowAgents": ["main", "computer", "search"] }
      // }
    ]
  },

  // --- Channel Routing ---
  // All channels route to main. Computer and search have no binding —
  // unreachable from channels, only via sessions_send.
  // channel-guard scans inbound, agent-guard scans the main→computer boundary.
  //
  // OPTIONAL: Dedicated channel agents (defense-in-depth)
  // If you uncommented the channel agents above, replace these bindings with:
  //   { "agentId": "whatsapp", "match": { "channel": "whatsapp" } },
  //   { "agentId": "signal", "match": { "channel": "signal" } },
  //   { "agentId": "googlechat", "match": { "channel": "googlechat" } }
  // TODO: remove after openclaw#15176 merges
  // NOTE: Channel bindings to non-default agents broken in 2026.2.12
  // (session path regression). Keep main-routes-all until the fix lands.
  "bindings": [
    { "agentId": "main", "match": { "channel": "whatsapp" } },
    { "agentId": "main", "match": { "channel": "signal" } },
    { "agentId": "main", "match": { "channel": "googlechat" } }
  ],

  // --- Channel Configuration ---
  "channels": {
    "whatsapp": {
      "dmPolicy": "pairing",
      "selfChatMode": false,
      "allowFrom": ["+46XXXXXXXXX"], // REPLACE with real number — placeholder causes silent message drops
      "groupPolicy": "allowlist",
      "groups": { "*": { "requireMention": true } },
      "mediaMaxMb": 50,
      "debounceMs": 0
    },
    "signal": {
      "enabled": true,
      "account": "+46XXXXXXXXX",
      "dmPolicy": "pairing",
      "allowFrom": ["+46XXXXXXXXX"], // REPLACE with real number — placeholder causes silent message drops
      "groupPolicy": "allowlist",
      "mediaMaxMb": 8
    },
    "googlechat": {
      "enabled": true,
      "serviceAccountFile": "${GOOGLE_CHAT_SERVICE_ACCOUNT_FILE}",
      "audienceType": "app-url",
      "audience": "https://<node-name>.<tailnet>.ts.net/googlechat",
      "dm": {
        "policy": "allowlist",
        "allowFrom": ["user@yourdomain.com"] // REPLACE with real email — placeholder causes silent message drops
      },
      "groupPolicy": "allowlist",
      "groups": { "*": { "requireMention": true } },
      "mediaMaxMb": 20
    }
  },

  // --- Browser ---
  // Required for the computer agent's browser tool. Uses a managed profile —
  // never your personal Chrome. evaluateEnabled:false blocks raw JS evaluation.
  "browser": {
    "enabled": true,
    "defaultProfile": "openclaw",
    "headless": true,
    "evaluateEnabled": false,
    "profiles": {
      "openclaw": { "cdpPort": 18800, "color": "#FF4500" }
    }
  },

  // --- Gateway ---
  "gateway": {
    "port": 18789,
    "mode": "local",
    "bind": "loopback",
    "auth": {
      "mode": "token",
      "token": "${OPENCLAW_GATEWAY_TOKEN}"
    }
  },

  // --- Network Discovery ---
  "discovery": {
    "mdns": { "mode": "minimal" }
  },

  // --- Logging ---
  "logging": {
    "redactSensitive": "tools",
    "redactPatterns": ["pplx-[A-Za-z0-9]+"]
  },

  // --- Plugins ---
  "plugins": {
    "entries": {
      "whatsapp": { "enabled": true },
      "signal": { "enabled": true },
      "googlechat": { "enabled": true },
      "channel-guard": {
        // Scans inbound channel messages for prompt injection before they reach agents.
        // failOpen:false — block message if scanner fails (safe default).
        "enabled": true,
        "config": {
          "failOpen": false,
          "sensitivity": 0.5,
          "warnThreshold": 0.4,
          "blockThreshold": 0.8
        }
      },
      "web-guard": {
        // Scans web_fetch responses for prompt injection before content reaches agent.
        // Protects computer and search agents from poisoned web content.
        "enabled": true,
        "config": {
          "failOpen": false,
          "sensitivity": 0.5,
          "timeoutMs": 10000,
          "maxContentLength": 50000
        }
      },
      "agent-guard": {
        // Scans sessions_send payloads crossing agent boundaries.
        // guardAgents: only scan outbound from main (high-risk boundary).
        // skipTargetAgents: skip low-privilege search agent (no exec, no fs).
        // This focuses scanning on the main→computer boundary where prompt
        // injection could lead to code execution on the egress-allowlisted network.
        "enabled": true,
        "config": {
          "failOpen": false,
          "sensitivity": 0.5,
          "warnThreshold": 0.4,
          "blockThreshold": 0.8,
          "guardAgents": ["main"],
          "skipTargetAgents": ["search"]
        }
      },
      "image-gen": {
        "enabled": true,
        "config": {
          // Uses $OPENROUTER_API_KEY from env (same key as Perplexity if configured)
          "defaultModel": "openai/gpt-5-image-mini",
          "defaultAspectRatio": "1:1",
          "defaultImageSize": "2K",
          "timeoutMs": 60000
        }
      }
    }
  }
}
